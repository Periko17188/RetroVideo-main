<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pedflix - Proyecto Final DAW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Inter',sans-serif;background-color:#141414;color:#E5E5E5}
        .header{background-color:#141414;z-index:10}
        .movie-card{transition:transform .3s, box-shadow .3s}
        .movie-card:hover{transform:scale(1.05);box-shadow:0 10px 20px rgba(0,0,0,.6)}
        .modal{background-color:rgba(0,0,0,.85);z-index:50}
        .modal input,.modal textarea{background:#333;color:#fff;border:1px solid #444}
        .animate-pulse-slow{animation:pulse 4s cubic-bezier(.4,0,.6,1) infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.8}}

        /* Carrito */
        #cart-container{position:relative}
        #cart-btn{position:relative}
        #cart-badge{
          position:absolute; right:-6px; bottom:-6px;
          min-width:18px; height:18px; padding:0 4px;
          background:#dc2626; color:#fff; border-radius:9999px;
          font-size:11px; line-height:18px; text-align:center; display:none;
        }
        #cart-dropdown{
          position:absolute; left:0; top:100%;
          background:#2d2d2d; border-radius:10px; box-shadow:0 8px 16px rgba(0,0,0,.5);
          width:340px; padding:12px; display:none;
        }
        .cart-item{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #444;padding:6px 0}
        .cart-item-title{font-size:.9rem}
        .cart-total{font-weight:700;margin-top:10px}
    </style>
</head>
<body class="min-h-screen">

<!-- HEADER -->
<header class="header sticky top-0 p-4 flex justify-end items-center shadow-lg">
    <div class="flex space-x-4 items-center">

        <!-- Registro / Login (cuando NO hay sesi√≥n) -->
        <button id="open-register-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded transition">
            Registrarse
        </button>
        <button id="open-login-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded transition">
            Iniciar Sesi√≥n
        </button>

        <!-- Carrito: a la IZQUIERDA de Bienvenida (solo USER, no ADMIN) -->
        <div id="cart-container" class="hidden">
            <button id="cart-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded transition flex items-center gap-2">
                üõí
                <span id="cart-badge">0</span>
            </button>
            <div id="cart-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-gray-800 rounded-md shadow-lg z-50 p-4">
                <h3 class="text-lg font-semibold text-white mb-3">Tu Carrito</h3>
                <div id="cart-items-list" class="space-y-2">
                    <!-- Los √≠tems se renderizar√°n aqu√≠ -->
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-white">Total:</span>
                        <span id="cart-total" class="font-bold text-lg text-white">0.00‚Ç¨</span>
                    </div>
                    <button onclick="checkout()" 
                            class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        Finalizar Compra
                    </button>
                </div>
            </div>
        </div>

        <!-- Bienvenida + Logout -->
        <span id="user-display" class="hidden bg-green-600 text-white font-semibold py-2 px-4 rounded"></span>
        <button id="logout-btn" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded transition">
            Cerrar Sesi√≥n
        </button>
    </div>
</header>

<!-- SPLASH -->
<div id="splash-screen" class="flex flex-col items-center justify-center min-h-[calc(100vh-80px)] text-center px-4">
    <div class="text-red-600 text-6xl sm:text-7xl md:text-8xl font-black mb-8 animate-pulse-slow">PEDFLIX</div>
    <p class="text-xl text-gray-300 mb-12 max-w-lg">
        Disfruta de pel√≠culas ilimitadas. Inicia sesi√≥n o reg√≠strate para acceder al cat√°logo.
    </p>
</div>

<!-- MAIN -->
<main id="main-content" class="p-8 hidden">

    <!-- FORM ADMIN (solo para Pedro) -->
    <section id="movie-form-section" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-8 hidden">
        <h2 class="text-2xl font-bold mb-4 text-red-600">Gesti√≥n de Pel√≠culas (ADMIN)</h2>
        <form id="movie-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" id="movieId" name="movieId">

            <div class="md:col-span-1">
                <label for="titulo" class="block text-sm font-medium mb-1">T√≠tulo:</label>
                <input type="text" id="titulo" name="titulo" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white">
            </div>

            <div class="md:col-span-1">
                <label for="anio" class="block text-sm font-medium mb-1">A√±o:</label>
                <input type="number" id="anio" name="anio" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white">
            </div>

            <div class="md:col-span-2">
                <label for="sinopsis" class="block text-sm font-medium mb-1">Sinopsis (Max 1000 chars):</label>
                <textarea id="sinopsis" name="sinopsis" maxlength="1000" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white h-24"></textarea>
            </div>

            <div class="md:col-span-1">
                <label for="rating" class="block text-sm font-medium mb-1">Puntuaci√≥n (0.0 a 10.0):</label>
                <input type="number" id="rating" name="rating" step="0.1" min="0" max="10" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white">
            </div>

            <div class="md:col-span-1">
                <label for="imagenUrl" class="block text-sm font-medium mb-1">Nombre Archivo Imagen (ej: dune.jpg):</label>
                <input type="text" id="imagenUrl" name="imagenUrl" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white" placeholder="solo_el_nombre.png">
            </div>

            <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1">G√©nero:</label>
                <div id="genre-select-container" class="relative"><!-- select por JS --></div>
                <p id="genre-load-message" class="text-sm text-gray-400 mt-2">Cargando g√©neros...</p>
            </div>

            <div class="md:col-span-2 flex justify-end space-x-4">
                <button type="button" id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition hidden">Cancelar Edici√≥n</button>
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">Guardar Pel√≠cula</button>
            </div>

            <p id="form-message" class="md:col-span-2 text-center mt-2 hidden"></p>
        </form>
    </section>

    <h1 class="text-4xl font-bold mb-8">Cat√°logo Completo</h1>

    <!-- FILTROS -->
    <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-4">Filtrar Contenido</h2>
        <div id="genres-container" class="flex flex-wrap gap-3"><!-- botones por JS --></div>
    </section>

    <!-- PEL√çCULAS -->
    <section>
        <h2 class="text-2xl font-semibold mb-4">Todas las Pel√≠culas</h2>
        <div id="movies-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            <!-- tarjetas por JS -->
        </div>
        <p id="no-movies-message" class="hidden text-xl text-center mt-10">No hay pel√≠culas que coincidan con el filtro.</p>
    </section>
</main>

<!-- LOGIN MODAL -->
<div id="login-modal" class="modal fixed inset-0 hidden items-center justify-center p-4">
    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
        <div class="flex justify-end">
            <button class="text-gray-400 hover:text-white text-2xl" onclick="closeModal('login-modal')">&times;</button>
        </div>
        <h3 class="text-3xl font-bold text-white mb-6 text-center">Inicia Sesi√≥n en PEDFLIX</h3>
        <div id="login-message" class="text-red-400 mb-4 hidden"></div>

        <label for="login-username" class="block text-sm font-medium mb-2">Usuario</label>
        <input type="text" id="login-username" class="w-full p-3 mb-4 rounded" value="Pedro">

        <label for="login-password" class="block text-sm font-medium mb-2">Contrase√±a</label>
        <input type="password" id="login-password" class="w-full p-3 mb-6 rounded" value="12341234">

        <button onclick="handleLogin()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded transition">
            Entrar
        </button>
    </div>
</div>

<!-- REGISTER MODAL -->
<div id="register-modal" class="modal fixed inset-0 hidden items-center justify-center p-4">
    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
        <div class="flex justify-end">
            <button class="text-gray-400 hover:text-white text-2xl" onclick="closeModal('register-modal')">&times;</button>
        </div>
        <h3 class="text-3xl font-bold text-white mb-6 text-center">Crea tu Cuenta PEDFLIX</h3>
        <div id="register-message" class="mb-4 text-center hidden"></div>

        <label for="register-username" class="block text-sm font-medium mb-2">Nuevo Usuario</label>
        <input type="text" id="register-username" class="w-full p-3 mb-4 rounded" placeholder="Escribe tu nombre de usuario">

        <label for="register-password" class="block text-sm font-medium mb-2">Contrase√±a (M√≠nimo 8)</label>
        <input type="password" id="register-password" class="w-full p-3 mb-6 rounded" placeholder="Escribe tu contrase√±a">

        <button onclick="handleRegister()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded transition">
            Registrarse
        </button>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/api/v1';

    // Estado global
    let movies = [];
    let genres = [];
    let isAuthenticated = false;
    let authUsername = null;
    let authPassword = null;
    let currentEditId = null;

    // Carrito (solo para USER)
    let cart = []; // {id, titulo}

    // --- Modales ---
    function openModal(id){
      const el=document.getElementById(id);
      el.classList.remove('hidden');el.classList.add('flex');
      if(id==='login-modal') document.getElementById('login-message').classList.add('hidden');
      if(id==='register-modal') document.getElementById('register-message').classList.add('hidden');
    }
    function closeModal(id){
      const el=document.getElementById(id);
      el.classList.add('hidden');el.classList.remove('flex');
      if(id==='movie-form-section') resetMovieForm();
    }

    // --- UI seg√∫n sesi√≥n ---
    function updateUI(user, logged=false){
      const openLogin=document.getElementById('open-login-btn');
      const openRegister=document.getElementById('open-register-btn');
      const logoutBtn=document.getElementById('logout-btn');
      const userDisplay=document.getElementById('user-display');
      const movieFormSection=document.getElementById('movie-form-section');
      const splash=document.getElementById('splash-screen');
      const main=document.getElementById('main-content');
      const cartContainer=document.getElementById('cart-container');

      isAuthenticated = logged;
      authUsername = user || null;

      if(logged){
        splash.classList.add('hidden'); main.classList.remove('hidden');
        openLogin.classList.add('hidden'); openRegister.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        userDisplay.textContent = `Bienvenida, ${user}`; // texto solicitado
        userDisplay.classList.remove('hidden');

        // ADMIN solo para Pedro
        movieFormSection?.classList.toggle('hidden', user !== 'Pedro');

        // Carrito: solo usuarios normales (no Pedro)
        cartContainer.classList.toggle('hidden', user === 'Pedro');

      }else{
        splash.classList.remove('hidden'); main.classList.add('hidden');
        openLogin.classList.remove('hidden'); openRegister.classList.remove('hidden');
        logoutBtn.classList.add('hidden'); userDisplay.classList.add('hidden');
        movieFormSection?.classList.add('hidden');
        document.getElementById('cart-container').classList.add('hidden');
      }
    }

    function handleLogout(){
      authUsername=null; authPassword=null;
      cart = []; updateCartUI();
      updateUI(null,false);
      showCustomMessage('Has cerrado sesi√≥n correctamente.','success');
    }

    // --- Login / Registro ---
    async function handleLogin(){
      const username=document.getElementById('login-username').value;
      const password=document.getElementById('login-password').value;
      const msg=document.getElementById('login-message');
      msg.classList.add('hidden');
      const base64=btoa(`${username}:${password}`);

      try{
        const res=await fetch(`${API_URL}/peliculas`,{headers:{'Authorization':`Basic ${base64}`}});

        if(res.ok){
          authUsername=username; authPassword=password;
          updateUI(username,true);
          closeModal('login-modal');
          await fetchGenres();
          await fetchMovies();
          showCustomMessage(`¬°Inicio de sesi√≥n exitoso! Bienvenida, ${username}.`,'success');
        }else if(res.status===401){
          msg.textContent='Usuario o contrase√±a incorrectos.'; msg.classList.remove('hidden');
        }else{
          msg.textContent='Error desconocido al iniciar sesi√≥n.'; msg.classList.remove('hidden');
        }
      }catch(err){
        msg.textContent='Error de conexi√≥n con el servidor.'; msg.classList.remove('hidden');
      }
    }

    async function handleRegister(){
      const username=document.getElementById('register-username').value;
      const password=document.getElementById('register-password').value;
      const msg=document.getElementById('register-message');
      msg.classList.add('hidden'); msg.classList.remove('text-red-400','text-green-400');

      if(username.length<3 || password.length<8){
        msg.textContent='El usuario debe tener al menos 3 caracteres y la contrase√±a al menos 8.';
        msg.classList.remove('hidden'); msg.classList.add('text-red-400'); return;
      }
      try{
        const res=await fetch(`${API_URL}/registro`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({username,password})
        });
        if(res.status===201){
          msg.textContent=`¬°Registro exitoso! Ya puedes iniciar sesi√≥n con ${username}.`;
          msg.classList.remove('hidden'); msg.classList.add('text-green-400');
          document.getElementById('register-username').value='';
          document.getElementById('register-password').value='';
        }else if(res.status===400){
          msg.textContent='El nombre de usuario ya est√° en uso.';
          msg.classList.remove('hidden'); msg.classList.add('text-red-400');
        }else{
          msg.textContent=`Error ${res.status} al registrar.`; msg.classList.remove('hidden'); msg.classList.add('text-red-400');
        }
      }catch(e){
        msg.textContent='Error de conexi√≥n con el servidor.'; msg.classList.remove('hidden'); msg.classList.add('text-red-400');
      }
    }

    // --- Form Admin ---
    function resetMovieForm(){
      const form=document.getElementById('movie-form');
      form.reset(); currentEditId=null;
      document.getElementById('form-message').classList.add('hidden');
      document.getElementById('cancel-edit-btn').classList.add('hidden');
      form.querySelector('button[type="submit"]').textContent='Guardar Pel√≠cula';
    }

    async function handleMovieFormSubmit(e){
      e.preventDefault();
      const form=e.target; const msg=document.getElementById('form-message');
      msg.classList.add('hidden'); msg.classList.remove('text-green-400','text-red-400');

      const movieData={
        titulo: form.titulo.value,
        sinopsis: form.sinopsis.value,
        anio: parseInt(form.anio.value),
        imagenUrl: form.imagenUrl.value || null,
        rating: parseFloat(form.rating.value),
        genreIds: [parseInt(form.genreId.value)]
      };

      if(!isAuthenticated || !authUsername || !authPassword){
        msg.textContent='Debes iniciar sesi√≥n como ADMIN.'; msg.classList.remove('hidden'); msg.classList.add('text-red-400'); return;
      }

      const base64=btoa(`${authUsername}:${authPassword}`);
      const headers={'Content-Type':'application/json','Authorization':`Basic ${base64}`};

      let url=`${API_URL}/peliculas`; let method='POST';
      if(currentEditId){ url=`${API_URL}/peliculas/${currentEditId}`; method='PUT'; }

      try{
        const res=await fetch(url,{method,headers,body: JSON.stringify(movieData),credentials: 'include'});
        const expected = method==='POST'?201:200;
        if(res.status===expected){
          msg.textContent=`Pel√≠cula "${movieData.titulo}" ${method==='POST'?'a√±adida':'actualizada'} correctamente.`;
          msg.classList.remove('hidden'); msg.classList.add('text-green-400');
          resetMovieForm(); await fetchMovies();
        }else if(res.status===401 || res.status===403){
          msg.textContent='No tienes permisos de ADMIN.'; msg.classList.remove('hidden'); msg.classList.add('text-red-400');
        }else{
          const t=await res.text();
          msg.textContent=`Error ${res.status}: ${t.substring(0,100)}...`; msg.classList.remove('hidden'); msg.classList.add('text-red-400');
        }
      }catch(e){
        msg.textContent='Error de conexi√≥n con el servidor.'; msg.classList.remove('hidden'); msg.classList.add('text-red-400');
      }
    }

    // --- Mensajes superiores (confirmaciones) ---
    function showCustomMessage(text,type='info'){
      let box=document.getElementById('custom-message-box');
      if(!box){
        box=document.createElement('div');
        box.id='custom-message-box';
        box.className='fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 p-4 rounded-lg shadow-xl text-center transition-opacity duration-500 opacity-0 z-50';
        document.body.appendChild(box);
      }
      box.textContent=text;
      box.className = 'fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 p-4 rounded-lg shadow-xl text-center transition-opacity duration-500 z-50 ' + (type==='success'?'bg-green-600 text-white':'bg-yellow-500 text-white');
      box.style.opacity='1';
      setTimeout(()=>{box.style.opacity='0';},3000);
    }

    // --- Pel√≠culas y G√©neros ---
    function createMovieCard(movie){
      const card=document.createElement('div');
      card.className='movie-card bg-gray-900 rounded-lg overflow-hidden relative';
      const imageFileName=movie.imagenUrl;
      const imageUrl=imageFileName?`images/${imageFileName}`:null;
      const placeholder='images/placeholder.png';
      const genreName=(movie.generos && movie.generos.length>0)?movie.generos[0].nombre:'Desconocido';

      card.innerHTML=`
        <img src="${imageUrl?imageUrl:placeholder}" alt="${movie.titulo}"
             onerror="this.onerror=null; this.src='${placeholder}';"
             class="w-full h-auto object-cover rounded-t-lg aspect-[2/3]">
        <div class="p-4">
          <h4 class="text-lg font-bold truncate">${movie.titulo}</h4>
          <p class="text-sm text-gray-400">${movie.anio} | ${genreName}</p>
          <p class="text-sm text-yellow-500 mt-1">‚≠ê ${movie.rating!=null?movie.rating.toFixed(1):'N/A'} / 10</p>
          <div class="mt-3 flex items-center justify-between">
          <button
              class="buy-btn bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-1 px-3 rounded transition hidden"
              data-movie-id="${movie.id}">Comprar Pel√≠cula
            </button>            <div class="admin-buttons space-x-2 hidden"></div>
          </div>
        </div>
      `;

      // Botones admin (Pedro)
      if(authUsername==='Pedro'){
        const adminDiv=card.querySelector('.admin-buttons');
        adminDiv.classList.remove('hidden');

        const editBtn=document.createElement('button');
        editBtn.innerHTML='‚úèÔ∏è';
        editBtn.className='bg-blue-600 hover:bg-blue-700 text-white text-xs p-1 rounded';
        editBtn.title='Editar';
        editBtn.onclick=(e)=>{e.stopPropagation(); populateEditForm(movie);};
        adminDiv.appendChild(editBtn);

        const delBtn=document.createElement('button');
        delBtn.innerHTML='üóëÔ∏è';
        delBtn.className='bg-red-600 hover:bg-red-700 text-white text-xs p-1 rounded';
        delBtn.title='Eliminar';
        delBtn.onclick=(e)=>{e.stopPropagation(); handleDeleteMovie(movie.id,movie.titulo);};
        adminDiv.appendChild(delBtn);
      }

      // Bot√≥n comprar (solo USER)
      if(isAuthenticated && authUsername && authUsername!=='Pedro'){
        const buyBtn=card.querySelector('.buy-btn');
        buyBtn.classList.remove('hidden');
        buyBtn.onclick=()=>handleBuy(movie, buyBtn);
      }

      return card;
    }

    function renderMovies(list){
      const container=document.getElementById('movies-container');
      const message=document.getElementById('no-movies-message');
      container.innerHTML='';
      if(!Array.isArray(list)){message.textContent="Error al mostrar las pel√≠culas.";message.classList.remove('hidden');return;}
      if(list.length===0){message.textContent="No hay pel√≠culas que coincidan con el filtro actual.";message.classList.remove('hidden');}
      else{
        message.classList.add('hidden');
        list.forEach(m => m && m.titulo ? container.appendChild(createMovieCard(m)) : null);
      }
    }

    function filterAndRenderMovies(genreId){
      if(!Array.isArray(movies)) movies=[];
      let filtered=movies;
      if(genreId!=='all'){
        filtered=movies.filter(m => m.generos && m.generos.some(g => g.id===parseInt(genreId)));
      }
      document.querySelectorAll('.genre-btn').forEach(btn=>btn.classList.replace('bg-red-600','bg-gray-700'));
      const active=document.querySelector(`.genre-btn[data-genre-id="${genreId}"]`);
      if(active) active.classList.replace('bg-gray-700','bg-red-600');
      renderMovies(filtered);
    }

    function createGenreButton(genre){
      const b=document.createElement('button');
      b.textContent=genre.nombre;
      b.className='genre-btn bg-gray-700 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full transition';
      b.dataset.genreId=genre.id;
      b.onclick=()=>filterAndRenderMovies(b.dataset.genreId);
      return b;
    }

    function handleFetchError(error,type){
      console.error(`Error al cargar ${type}:`, error);
      let containerId, formMessageId, errorMessage;
      if(type==='g√©neros'){containerId='genres-container';formMessageId='genre-load-message';errorMessage='Error: No se pudo conectar a la API para cargar los g√©neros.';}
      else{containerId='movies-container';formMessageId='no-movies-message';errorMessage='Error al conectar con el servidor de pel√≠culas.';}

      const container=document.getElementById(containerId);
      if(container){container.innerHTML=`<span class="text-red-400">${errorMessage} Aseg√∫rate de que el backend est√© ejecut√°ndose en http://localhost:8080.</span>`;}
      const formMsg=document.getElementById(formMessageId);
      if(formMsg){
        formMsg.textContent = type==='g√©neros' ? 'Error: No se pudieron cargar los g√©neros para el formulario.' : errorMessage;
        formMsg.classList.remove('hidden'); formMsg.classList.add('text-red-400');
      }
      if(type==='g√©neros') genres=[]; if(type==='pel√≠culas') movies=[];
      renderMovies([]);
    }

    async function fetchGenres(){
      try{
        let headers={};
        if(isAuthenticated && authUsername && authPassword){
          const base64=btoa(`${authUsername}:${authPassword}`); headers={'Authorization':`Basic ${base64}`};
        }
        const res=await fetch(`${API_URL}/generos`,{headers});
        if(!res.ok) throw new Error(`Error ${res.status}`);
        genres=await res.json();

        const cont=document.getElementById('genres-container'); cont.innerHTML='';
        const allBtn=document.createElement('button');
        allBtn.textContent='Todos';
        allBtn.className='genre-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-full transition';
        allBtn.dataset.genreId='all';
        allBtn.onclick=()=>filterAndRenderMovies('all');
        cont.appendChild(allBtn);

        if(Array.isArray(genres)){
          genres.forEach(g=>{ if(g && g.nombre) cont.appendChild(createGenreButton(g)); });
        }else{ genres=[]; }

        const selectContainer=document.getElementById('genre-select-container');
        const selectMsg=document.getElementById('genre-load-message');
        if(selectContainer){
          let html=`<select id="genreId" name="genreId" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white">`;
          if(Array.isArray(genres)){ genres.forEach(g=>{ if(g && g.nombre) html+=`<option value="${g.id}">${g.nombre}</option>`; }); }
          html+='</select>';
          selectContainer.innerHTML=html; selectMsg.classList.add('hidden');
        }
      }catch(e){ handleFetchError(e,'g√©neros'); }
    }

    async function fetchMovies(){
      try{
        let headers={};
        if(isAuthenticated && authUsername && authPassword){
          const base64=btoa(`${authUsername}:${authPassword}`); headers={'Authorization':`Basic ${base64}`};
        }
        const res=await fetch(`${API_URL}/peliculas`,{headers});
        if(!res.ok) throw new Error(`Error ${res.status}`);
        movies=await res.json();
        if(!Array.isArray(movies)) movies=[];
        filterAndRenderMovies('all');
      }catch(e){ handleFetchError(e,'pel√≠culas'); }
    }

    // --- Admin: editar / borrar ---
    function populateEditForm(movie){
      const form=document.getElementById('movie-form');
      form.titulo.value=movie.titulo; form.anio.value=movie.anio; form.sinopsis.value=movie.sinopsis; form.rating.value=movie.rating;
      form.imagenUrl.value=movie.imagenUrl||'';
      form.genreId.value= movie.generos && movie.generos.length>0 ? movie.generos[0].id : '';
      currentEditId=movie.id;
      document.getElementById('cancel-edit-btn').classList.remove('hidden');
      form.querySelector('button[type="submit"]').textContent='Actualizar Pel√≠cula';
      document.getElementById('movie-form-section').scrollIntoView({behavior:'smooth'});
    }

    async function handleDeleteMovie(id,title){
      if(!confirm(`¬øEliminar "${title}"?`)) return;
      if(!isAuthenticated || !authUsername || !authPassword){ showCustomMessage('Debes iniciar sesi√≥n como ADMIN.','error'); return; }
      const base64=btoa(`${authUsername}:${authPassword}`);
      try{
        const res=await fetch(`${API_URL}/peliculas/${id}`,{method: 'DELETE',headers:
        {'Authorization': `Basic ${base64}`},credentials: 'include'});
        if(res.status===204){ showCustomMessage(`"${title}" eliminada.`,'success'); await fetchMovies(); }
        else if(res.status===401||res.status===403){ showCustomMessage('No tienes permisos de ADMIN.','error'); }
        else{ showCustomMessage(`Error ${res.status} al eliminar.`,'error'); }
      }catch(e){ showCustomMessage('Error de conexi√≥n.','error'); }
    }

    // ========== CARRITO ==========
    // A√±adir pel√≠cula al carrito y actualizar bot√≥n
    async function handleBuy(movie, btn) {
    const base64 = btoa(`${authUsername}:${authPassword}`);

    const res = await fetch(`${API_URL}/cart/add/${movie.id}`, {
        method: "POST",
        headers: { "Authorization": `Basic ${base64}` }
    });

    if (res.ok) {
        btn.textContent = "A√±adida ‚úÖ";
        btn.disabled = true;
        await loadCartFromBackend(); // ‚¨Ö carrito REAL
        showCustomMessage("Pel√≠cula a√±adida al carrito", "success");
    } else {
        showCustomMessage("Error al a√±adir al carrito", "error");
    }
}

    // Actualiza badge, listado desplegable y visibilidad
    function updateCartUI() {
    const cartItemsList = document.getElementById('cart-items-list');
    const cartTotal = document.getElementById('cart-total');
    const cartBadge = document.getElementById('cart-badge');
    
    // Actualizar contador del carrito
    const itemCount = cart.reduce((total, item) => total + (item.quantity || 1), 0);
    cartBadge.textContent = itemCount;
    cartBadge.style.display = itemCount > 0 ? 'inline-block' : 'none';
    
    if (cart.length === 0) {
        cartItemsList.innerHTML = '<p class="text-gray-400 py-4 text-center">Tu carrito est√° vac√≠o</p>';
        cartTotal.textContent = '0.00‚Ç¨';
        return;
    }

    let total = 0;
    cartItemsList.innerHTML = cart.map(item => {
        const itemTotal = (item.price || 5.99) * (item.quantity || 1);
        total += itemTotal;
        
        return `
            <div class="flex justify-between items-center p-2 hover:bg-gray-700 rounded">
                <div class="flex-1">
                    <p class="text-white">${item.movie?.titulo || 'Pel√≠cula'}</p>
                    <p class="text-gray-400 text-sm">${(item.price || 5.99).toFixed(2)}‚Ç¨ c/u</p>
                </div>
                    <div class="flex items-center">
                        <!-- Grupo de botones de cantidad -->
                        <div class="flex items-center space-x-1">
                            <button onclick="updateCartItemQuantity(${item.id}, ${(item.quantity || 1) - 1})" 
                                    class="px-2 py-1 bg-gray-600 rounded hover:bg-gray-500">-</button>
                            <span class="w-8 text-center">${item.quantity || 1}</span>
                            <button onclick="updateCartItemQuantity(${item.id}, ${(item.quantity || 1) + 1})" 
                                    class="px-2 py-1 bg-gray-600 rounded hover:bg-gray-500">+</button>
                        </div>
                        <!-- Bot√≥n de eliminar con margen izquierdo -->
                        <button onclick="removeFromCart(${item.id})" 
                                class="ml-3 px-3 py-1 bg-red-600 text-white rounded hover:bg-red-500">
                            √ó
                        </button>
                    </div>
            </div>
        `;
    }).join('');

    cartTotal.textContent = `${total.toFixed(2)}‚Ç¨`;
}

async function updateCartItemQuantity(itemId, newQuantity) {
    if (newQuantity < 1) return;
    
    const base64 = btoa(`${authUsername}:${authPassword}`);
    try {
        const res = await fetch(`${API_URL}/cart/${itemId}/quantity?quantity=${newQuantity}`, {
            method: 'PUT',
            headers: { 
                'Authorization': `Basic ${base64}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (res.ok) {
            await loadCartFromBackend();
        } else {
            const error = await res.text();
            showCustomMessage(error || 'Error al actualizar la cantidad', 'error');
        }
    } catch (e) {
        console.error('Error al actualizar cantidad:', e);
        showCustomMessage('Error de conexi√≥n', 'error');
    }
}

function syncBuyButtonsWithCart() {
  // Si el carrito viene del backend: item.movie.id
  const idsEnCarrito = new Set(
    cart.map(item => item.movie ? item.movie.id : item.id) // por si a√∫n usas formato antiguo
  );

  document.querySelectorAll('.buy-btn').forEach(btn => {
    const movieId = Number(btn.dataset.movieId);

    if (idsEnCarrito.has(movieId)) {
      btn.textContent = 'A√±adida ‚úÖ';
      btn.disabled = true;
    } else {
      btn.textContent = 'Comprar Pel√≠cula';
      btn.disabled = false;
    }
  });
}


    // Eliminar del carrito por √≠ndice y refrescar badge/lista
    async function removeFromCart(cartItemId) {
    const base64 = btoa(`${authUsername}:${authPassword}`);

    const res = await fetch(`${API_URL}/cart/${cartItemId}`, {
        method: "DELETE",
        headers: { "Authorization": `Basic ${base64}` }
    });

    if (res.ok) {
        await loadCartFromBackend(); // actualiza carrito REAL
        showCustomMessage("Art√≠culo eliminado del carrito", "success");
    } else {
        showCustomMessage("Error al eliminar del carrito", "error");
    }
}

    // Finalizar compra -> backend /orders/checkout
    async function checkout(){
      if(cart.length === 0){
        showCustomMessage('El carrito est√° vac√≠o','info');
        return;
      }

      try {
        const base64 = btoa(`${authUsername}:${authPassword}`);
        const res = await fetch(`${API_URL}/orders/checkout`, {
          method: 'POST',
          headers: {
            'Authorization': `Basic ${base64}`,
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        });

        const result = await res.json();

        if(res.ok) {
          // Vaciar el carrito solo despu√©s de una compra exitosa
          cart = [];
          updateCartUI();
          // Recargar el carrito desde el backend para asegurar consistencia
          await loadCartFromBackend();
          // Re-activar botones de compra en las tarjetas
          document.querySelectorAll('.buy-btn').forEach(b => {
            b.textContent = 'Comprar Pel√≠cula';
            b.disabled = false;
          });
          showCustomMessage(result.message || 'Compra realizada con √©xito', 'success');
        } else {
          showCustomMessage(result || 'Error al procesar la compra', 'error');
        }
      } catch(e) {
        console.error('Error en checkout:', e);
        showCustomMessage('Error de conexi√≥n: ' + e.message, 'error');
      }
    }

    async function loadCartFromBackend() {
    const base64 = btoa(`${authUsername}:${authPassword}`);

    const res = await fetch(`${API_URL}/cart`, {
        headers: { "Authorization": `Basic ${base64}` }
    });

    if (res.ok) {
        cart = await res.json();   // carrito real
        updateCartUI();
        syncBuyButtonsWithCart();  // ‚¨Ö sincroniza botones
    }
}

    // Toggle del desplegable del carrito
    document.addEventListener('click', (ev)=>{
      const cartContainer = document.getElementById('cart-container');
      const dd=document.getElementById('cart-dropdown');
      const btn=document.getElementById('cart-btn');
      if(btn && btn.contains(ev.target)){
        dd.style.display = (dd.style.display==='block'?'none':'block');
      }else if(cartContainer && !cartContainer.contains(ev.target)){
        dd.style.display='none';
      }
    });

    // --- Inicializaci√≥n ---
    document.addEventListener('DOMContentLoaded', ()=>{
      updateUI(null,false);

      document.getElementById('open-login-btn').addEventListener('click', ()=>openModal('login-modal'));
      document.getElementById('open-register-btn').addEventListener('click', ()=>openModal('register-modal'));
      document.getElementById('logout-btn').addEventListener('click', handleLogout);

      const movieForm=document.getElementById('movie-form');
      if(movieForm){
        movieForm.addEventListener('submit', handleMovieFormSubmit);
        document.getElementById('cancel-edit-btn').addEventListener('click', resetMovieForm);
      }
    });

</script>
</body>
</html>